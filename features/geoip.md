# GeoIP Enrichment

> **Edition: OSS** | **Status: Shipped** | **Enforcement: Userspace** | **Domain: alias (GeoIP lookups)**

## Overview

eBPFsentinel integrates MaxMind GeoLite2/GeoIP2 databases to enrich alerts with geographic and network ownership information. When an alert is generated by any domain engine (firewall, IDS, IPS, threat intel, etc.), the source and destination IP addresses are automatically looked up in the GeoIP database, and the results are attached to the alert as `src_geo` and `dst_geo` fields.

Three provisioning modes are supported:

| Mode | Description |
|------|-------------|
| **MaxMind Account** | Auto-download databases from MaxMind using account credentials |
| **URL** | Download from a self-hosted mirror or internal URL |
| **File** | Load from pre-downloaded `.mmdb` files on disk |

## How It Works

### Lookup Pipeline

```
Alert generated by domain engine
    │
    ▼
DnsAlertEnricher
    ├── DNS reverse lookup (existing)
    ├── Domain reputation scoring (existing)
    │
    └── GeoIP enrichment (new)
        ├── src_ip → GeoIpPort::lookup() → src_geo
        └── dst_ip → GeoIpPort::lookup() → dst_geo
```

### GeoIP Data Fields

Each lookup returns:

| Field | Type | Example | Description |
|-------|------|---------|-------------|
| `country_code` | ISO 3166-1 alpha-2 | `FR` | Two-letter country code |
| `country_name` | string | `France` | Full country name |
| `city` | string | `Paris` | City name (if available) |
| `asn` | integer | `3215` | Autonomous System Number |
| `as_org` | string | `Orange S.A.` | AS organization name |
| `latitude` | float | `48.8566` | Latitude coordinate |
| `longitude` | float | `2.3522` | Longitude coordinate |

### Compact Alert Format

GeoIP data is serialized as a compact string in the alert's `src_geo` / `dst_geo` fields:

```
FR/Paris (ASN: AS3215 Orange S.A.)
```

Format: `{country_code}/{city} (ASN: AS{asn} {as_org})`

If only a country code is available: `US`. If no city but ASN: `DE (ASN: AS3320 Deutsche Telekom AG)`.

### Database Support

Two MaxMind database types are used:

| Database | Content | File |
|----------|---------|------|
| **City** | Country, city, coordinates | `GeoLite2-City.mmdb` or `GeoIP2-City.mmdb` |
| **ASN** | AS number, organization | `GeoLite2-ASN.mmdb` or `GeoIP2-ASN.mmdb` |

Both are optional — if only the City database is available, ASN fields will be empty and vice versa. At minimum, the City database is required for `is_ready()` to return true.

## Provisioning Modes

### Mode 1: MaxMind Account (auto-download)

Provide your MaxMind account ID and license key. Databases are downloaded automatically from the MaxMind API, extracted from `.tar.gz` archives, and stored locally.

```yaml
geoip:
  enabled: true
  source:
    mode: maxmind_account
    account_id: "123456"
    license_key: "your-license-key"
    edition_ids: ["GeoLite2-City", "GeoLite2-ASN"]
  refresh_interval_hours: 24
  database_dir: "/var/lib/ebpfsentinel/geoip"
```

Sign up for a free GeoLite2 account at [maxmind.com](https://www.maxmind.com/en/geolite2/signup).

### Mode 2: URL (self-hosted mirror)

Download databases from arbitrary URLs. Supports both raw `.mmdb` files and `.tar.gz` archives (auto-extracted).

```yaml
geoip:
  enabled: true
  source:
    mode: url
    city_url: "https://mirror.example.com/GeoLite2-City.mmdb"
    asn_url: "https://mirror.example.com/GeoLite2-ASN.mmdb"
  refresh_interval_hours: 24
  database_dir: "/var/lib/ebpfsentinel/geoip"
```

### Mode 3: File (local path)

Point directly to pre-downloaded `.mmdb` files. No network access required — suitable for air-gapped environments.

```yaml
geoip:
  enabled: true
  source:
    mode: file
    city_path: "/opt/geoip/GeoLite2-City.mmdb"
    asn_path: "/opt/geoip/GeoLite2-ASN.mmdb"
  refresh_interval_hours: 0
```

### Auto-Refresh

For `maxmind_account` and `url` modes, databases are periodically re-downloaded according to `refresh_interval_hours` (default: 24 hours). MaxMind updates GeoLite2 databases twice weekly.

Set `refresh_interval_hours: 0` to disable auto-refresh (useful for `file` mode or manual updates).

## Configuration

```yaml
geoip:
  enabled: true
  source:
    mode: file
    city_path: /opt/geoip/GeoLite2-City.mmdb
    asn_path: /opt/geoip/GeoLite2-ASN.mmdb
  refresh_interval_hours: 0
```

See [Configuration: GeoIP](../configuration/geoip.md) for the full reference.

## Alert Output

### JSON alert with GeoIP

```json
{
  "id": "alert-42",
  "timestamp_ns": 1709312345000000000,
  "component": "ids",
  "severity": "high",
  "rule_id": "ids-042",
  "src_addr": "203.0.113.42",
  "dst_addr": "10.0.1.5",
  "src_geo": "CN/Beijing (ASN: AS4808 China Unicom)",
  "dst_geo": null,
  "src_domain": "scanner.example.cn",
  "dst_domain": "web.internal"
}
```

Private/internal IPs (RFC 1918, link-local, etc.) typically return no GeoIP data — `src_geo` / `dst_geo` will be `null`.

## Code Architecture

| Crate | Path | Role |
|-------|------|------|
| `domain` | `crates/domain/src/alias/entity.rs` | `GeoIpInfo` entity + `format_compact()` |
| `ports` | `crates/ports/src/secondary/geoip_port.rs` | `GeoIpPort` trait (lookup + readiness) |
| `adapters` | `crates/adapters/src/geoip/maxmind_adapter.rs` | MaxMind `.mmdb` adapter (City + ASN) |
| `application` | `crates/application/src/alert_enrichment.rs` | Alert enrichment integration |
| `infrastructure` | `crates/infrastructure/src/config/geoip.rs` | Config parsing (3 modes) |
| `agent` | `crates/agent/src/startup.rs` | Wiring + periodic refresh |

## Metrics

- `ebpfsentinel_geoip_lookups_total` — total GeoIP lookups performed
- `ebpfsentinel_geoip_ready` — database readiness (1=loaded, 0=not loaded)
