# GeoIP Enrichment

> **Edition: OSS** | **Status: Shipped** | **Enforcement: Userspace + Kernel (LPM)** | **Domain: alias (GeoIP lookups)**

## Overview

eBPFsentinel integrates MaxMind GeoLite2/GeoIP2 databases for both **alert enrichment** and **cross-domain enforcement**. GeoIP data is used in two ways:

1. **Alert enrichment** — source and destination IPs are automatically looked up and attached to alerts as `src_geo` / `dst_geo` fields
2. **Enforcement** — 8 domain engines use GeoIP data for country-aware detection, blocking, and routing decisions, with kernel-side CIDR enforcement via coordinated LPM Trie maps

Three provisioning modes are supported:

| Mode | Description |
|------|-------------|
| **MaxMind Account** | Auto-download databases from MaxMind using account credentials |
| **URL** | Download from a self-hosted mirror or internal URL |
| **File** | Load from pre-downloaded `.mmdb` files on disk |

## How It Works

### Lookup Pipeline

```
Alert generated by domain engine
    │
    ▼
DnsAlertEnricher
    ├── DNS reverse lookup (existing)
    ├── Domain reputation scoring (existing)
    │
    └── GeoIP enrichment (new)
        ├── src_ip → GeoIpPort::lookup() → src_geo
        └── dst_ip → GeoIpPort::lookup() → dst_geo
```

### GeoIP Data Fields

Each lookup returns:

| Field | Type | Example | Description |
|-------|------|---------|-------------|
| `country_code` | ISO 3166-1 alpha-2 | `FR` | Two-letter country code |
| `country_name` | string | `France` | Full country name |
| `city` | string | `Paris` | City name (if available) |
| `asn` | integer | `3215` | Autonomous System Number |
| `as_org` | string | `Orange S.A.` | AS organization name |
| `latitude` | float | `48.8566` | Latitude coordinate |
| `longitude` | float | `2.3522` | Longitude coordinate |

### Compact Alert Format

GeoIP data is serialized as a compact string in the alert's `src_geo` / `dst_geo` fields:

```
FR/Paris (ASN: AS3215 Orange S.A.)
```

Format: `{country_code}/{city} (ASN: AS{asn} {as_org})`

If only a country code is available: `US`. If no city but ASN: `DE (ASN: AS3320 Deutsche Telekom AG)`.

### Database Support

Two MaxMind database types are used:

| Database | Content | File |
|----------|---------|------|
| **City** | Country, city, coordinates | `GeoLite2-City.mmdb` or `GeoIP2-City.mmdb` |
| **ASN** | AS number, organization | `GeoLite2-ASN.mmdb` or `GeoIP2-ASN.mmdb` |

Both are optional — if only the City database is available, ASN fields will be empty and vice versa. At minimum, the City database is required for `is_ready()` to return true.

## Provisioning Modes

### Mode 1: MaxMind Account (auto-download)

Provide your MaxMind account ID and license key. Databases are downloaded automatically from the MaxMind API, extracted from `.tar.gz` archives, and stored locally.

```yaml
geoip:
  enabled: true
  source:
    mode: maxmind_account
    account_id: "123456"
    license_key: "your-license-key"
    edition_ids: ["GeoLite2-City", "GeoLite2-ASN"]
  refresh_interval_hours: 24
  database_dir: "/var/lib/ebpfsentinel/geoip"
```

Sign up for a free GeoLite2 account at [maxmind.com](https://www.maxmind.com/en/geolite2/signup).

### Mode 2: URL (self-hosted mirror)

Download databases from arbitrary URLs. Supports both raw `.mmdb` files and `.tar.gz` archives (auto-extracted).

```yaml
geoip:
  enabled: true
  source:
    mode: url
    city_url: "https://mirror.example.com/GeoLite2-City.mmdb"
    asn_url: "https://mirror.example.com/GeoLite2-ASN.mmdb"
  refresh_interval_hours: 24
  database_dir: "/var/lib/ebpfsentinel/geoip"
```

### Mode 3: File (local path)

Point directly to pre-downloaded `.mmdb` files. No network access required — suitable for air-gapped environments.

```yaml
geoip:
  enabled: true
  source:
    mode: file
    city_path: "/opt/geoip/GeoLite2-City.mmdb"
    asn_path: "/opt/geoip/GeoLite2-ASN.mmdb"
  refresh_interval_hours: 0
```

### Auto-Refresh

For `maxmind_account` and `url` modes, databases are periodically re-downloaded according to `refresh_interval_hours` (default: 24 hours). MaxMind updates GeoLite2 databases twice weekly.

Set `refresh_interval_hours: 0` to disable auto-refresh (useful for `file` mode or manual updates).

## Configuration

```yaml
geoip:
  enabled: true
  source:
    mode: file
    city_path: /opt/geoip/GeoLite2-City.mmdb
    asn_path: /opt/geoip/GeoLite2-ASN.mmdb
  refresh_interval_hours: 0
```

See [Configuration: GeoIP](../configuration/geoip.md) for the full reference.

## Alert Output

### JSON alert with GeoIP

```json
{
  "id": "alert-42",
  "timestamp_ns": 1709312345000000000,
  "component": "ids",
  "severity": "high",
  "rule_id": "ids-042",
  "src_addr": "203.0.113.42",
  "dst_addr": "10.0.1.5",
  "src_geo": "CN/Beijing (ASN: AS4808 China Unicom)",
  "dst_geo": null,
  "src_domain": "scanner.example.cn",
  "dst_domain": "web.internal"
}
```

Private/internal IPs (RFC 1918, link-local, etc.) typically return no GeoIP data — `src_geo` / `dst_geo` will be `null`.

## Cross-Domain Enforcement

GeoIP data drives enforcement decisions across 8 domain engines. Country-to-CIDR resolution is performed via `AliasResolutionPort`, which resolves ISO 3166-1 alpha-2 country codes (e.g. `RU`, `CN`) to their CIDR ranges from the MaxMind database.

### LPM Coordinator

Kernel-side enforcement uses a shared `LpmCoordinator` that manages the firewall's 4 LPM Trie maps (`FW_LPM_SRC_V4/DST_V4/SRC_V6/DST_V6`). The coordinator tracks entry provenance by source tag (`alias`, `ddos:<CC>`, `ips`), so that each domain can insert/remove entries without overwriting other domains' data.

### Per-Domain Integration

| Domain | GeoIP Feature | Enforcement |
|--------|---------------|-------------|
| **DDoS** | Per-country detection thresholds (`country_thresholds`). When an attack from a high-risk country is active with `block` action, all CIDRs for that country are auto-injected into the LPM maps | Kernel (LPM) |
| **IPS** | Per-country blacklist thresholds (`country_thresholds`). When a high-risk country IP is blacklisted, the /24 (v4) or /48 (v6) subnet is injected into the LPM maps | Kernel (LPM) |
| **IDS** | Country-based sampling (`country_based` mode) — full inspection for high-risk countries, reduced rate for others. Per-country threshold overrides on rules | Userspace |
| **L7 Firewall** | Source and destination country matching (`src_country_codes`, `dst_country_codes`) on rules | Userspace |
| **Threat Intel** | Confidence boost for IOCs from high-risk source countries (`country_confidence_boost`) | Userspace |
| **DNS** | High-risk country reputation factor (`high_risk_countries`) — domains resolving to IPs in listed countries receive a `HighRiskCountry` factor (weight 0.4) | Userspace |
| **Rate Limit** | Per-country rate limit tiers via dedicated kernel LPM maps (`RL_LPM_SRC_V4/V6`, `RL_TIER_CONFIG`) — country CIDRs mapped to tier profiles | Kernel (LPM) |
| **Routing** | Geographic gateway preference (`preferred_for_countries`) — WAN gateways preferred for traffic to/from specific countries | Userspace |

### Enforcement Flow

```
GeoIP Database (MaxMind)
    │
    ├── AliasResolutionPort::lookup_geoip()
    │   └── Country code → Vec<IpNetwork> (CIDRs)
    │
    ├── Alert Enrichment (all domains)
    │   └── src_ip/dst_ip → src_geo/dst_geo on alerts
    │
    ├── LpmCoordinator (firewall LPM maps)
    │   ├── source: "alias"     — GeoIP alias rules
    │   ├── source: "ddos:<CC>" — DDoS country auto-block
    │   └── source: "ips"       — IPS /24 subnet injection
    │
    ├── RateLimitLpmManager (dedicated RL LPM maps)
    │   └── Country → tier_id → rate/burst/algorithm
    │
    └── Userspace engines (direct lookup)
        ├── IDS: country-aware sampling + thresholds
        ├── L7:  src/dst country rule matching
        ├── TI:  confidence boost
        ├── DNS: reputation scoring
        └── Routing: gateway selection
```

## Code Architecture

| Crate | Path | Role |
|-------|------|------|
| `domain` | `crates/domain/src/alias/entity.rs` | `GeoIpInfo` entity + `format_compact()` |
| `ports` | `crates/ports/src/secondary/geoip_port.rs` | `GeoIpPort` trait (lookup + readiness) |
| `ports` | `crates/ports/src/secondary/lpm_coordinator_port.rs` | `LpmCoordinatorPort` trait (multi-source LPM) |
| `ports` | `crates/ports/src/secondary/ratelimit_lpm_port.rs` | `RateLimitLpmPort` trait (country tier LPM) |
| `adapters` | `crates/adapters/src/geoip/maxmind_adapter.rs` | MaxMind `.mmdb` adapter (City + ASN) |
| `adapters` | `crates/adapters/src/ebpf/lpm_coordinator.rs` | `LpmCoordinator` (multi-source LPM map manager) |
| `adapters` | `crates/adapters/src/ebpf/ratelimit_lpm_manager.rs` | `RateLimitLpmManager` (RL LPM maps) |
| `application` | `crates/application/src/alert_enrichment.rs` | Alert enrichment integration |
| `infrastructure` | `crates/infrastructure/src/config/geoip.rs` | Config parsing (3 modes) |
| `agent` | `crates/agent/src/startup.rs` | Wiring + periodic refresh |

## Metrics

- `ebpfsentinel_geoip_lookups_total` — total GeoIP lookups performed
- `ebpfsentinel_geoip_ready` — database readiness (1=loaded, 0=not loaded)
